<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Delivery Drivers Log â€“ Ravintola Tandoori Villa</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"/>
  <style>
    :root {
      --main-bg: linear-gradient(135deg, #0d47a1 0%, #000 100%);
      --card-bg: #181c24;
      --primary: #42a5f5;
      --primary-hover: #1976d2;
      --accent: #bbdefb;
      --border: #212a40;
      --red: #ff3b30;
      --gap: 24px;
      --card-radius: 15px;
    }
    html, body {
      min-height: 100vh;
      margin: 0;
      padding: 0;
      background: var(--main-bg);
      box-sizing: border-box;
      width: 100vw;
      font-family: 'Poppins', Arial, sans-serif;
      color: #fff;
      overflow-x: hidden;
    }
    body {
      width: 100vw;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }
    .page-wrapper {
      width: 100vw;
      max-width: 100vw;
      margin: 0 auto;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      justify-content: flex-start;
      padding: 0;
      box-sizing: border-box;
    }
    .header {
      width: 100%;
      background: var(--card-bg);
      color: var(--accent);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 19px 16px 12px 16px;
      margin: 0 0 var(--gap) 0;
      margin-top: 24px;
      border-radius: var(--card-radius);
      box-shadow: 0 2px 9px rgba(66, 165, 245, 0.08);
      min-height: 43px;
      letter-spacing: 0.03em;
      max-width: 1100px;
      align-self: center;
    }
    .header-row {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .header-title {
      font-size: 1.17rem;
      font-weight: 800;
      color: #fff;
      font-family: 'Poppins', Arial, sans-serif;
      letter-spacing: 0.03em;
      text-shadow: 0 2px 12px #009de044;
      white-space: nowrap;
      flex: none;
      display: inline-flex;
      align-items: center;
      gap: 0.6em;
    }
    .header-desc {
      font-size: 0.99em;
      font-weight: 500;
      color: #bbdefb;
      opacity: 0.88;
      margin-left: 18px;
      font-family: 'Poppins', Arial, sans-serif;
      letter-spacing: 0.01em;
      text-align: center;
      flex: none;
      display: inline-block;
      white-space: normal;
      max-width: 68vw;
    }
    .driver-addbar {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.45em;
      margin: 13px 0 16px 0;
      width: 100%;
      max-width: 600px;
      padding: 0 3px;
      align-self: center;
    }
    .driver-addbar input[type="text"] {
      flex: 1;
      font-size: 1em;
      padding: 0.55em 1em;
      background: #212a40;
      border: none;
      border-radius: 9px;
      color: var(--accent);
      outline: none;
      font-family: 'Poppins', Arial, sans-serif;
      font-weight: 600;
      margin-right: 0.07em;
    }
    .driver-addbar button {
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 9px;
      font-size: 0.97rem;
      font-weight: 700;
      padding: 7px 18px;
      cursor: pointer;
      transition: background 0.16s;
      font-family: inherit;
      letter-spacing: 0.01em;
      display: flex;
      align-items: center;
      gap: 0.22em;
    }
    .driver-addbar button:hover { background: var(--primary-hover);}
    .log-board {
      display: grid;
      grid-template-columns: repeat(2, 1fr); /* DESKTOP: 2 cards per row */
      gap: var(--gap);
      width: 100vw;
      max-width: 1100px;
      align-items: stretch;
      margin: 0 auto 17px auto;
      padding: 0 12px;
      box-sizing: border-box;
      justify-items: center;
      overflow-x: hidden;
    }
    .driver-card {
      background: var(--card-bg);
      border-radius: var(--card-radius);
      box-shadow: 0 2px 8px rgba(66,165,245,0.08);
      border: 2px solid var(--border);
      padding: 0;
      display: flex;
      flex-direction: column;
      min-width: 0;
      max-width: 100%;
      font-size: 0.97rem;
      position: relative;
      margin-bottom: 0;
      margin-top: 16px;
      margin-bottom: 16px;
      word-break: break-word;
      transition: border 0.13s, box-shadow 0.13s;
      width: 100%;
      box-sizing: border-box;
    }
    .driver-card.active {
      border: 2.2px solid var(--primary);
      box-shadow: 0 2px 12px #42a5f52a;
    }
    .driver-card-header {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      padding: 12px 18px 8px 18px;
      background: #0d47a1;
      color: var(--accent);
      font-size: 1.07em;
      font-weight: 700;
      gap: 14px;
      border-bottom: 1px solid var(--border);
      border-top-left-radius: var(--card-radius);
      border-top-right-radius: var(--card-radius);
      box-sizing: border-box;
      flex-wrap: nowrap;
    }
    .driver-card-header .driver-name {
      font-size: 1.08em;
      font-weight: 700;
      color: #fff;
      flex: 1 1 auto;
      min-width: 0;
      letter-spacing: 0.04em;
      overflow-wrap: break-word;
      word-break: break-word;
      white-space: normal;
      display: inline-block;
      margin-right: 10px;
    }
    .driver-card-header .driver-date {
      font-size: 0.97em;
      color: #d5f5ff;
      background: #183350;
      border-radius: 0.5em;
      padding: 3px 8px;
      border: none;
      outline: none;
      font-family: inherit;
      font-weight: 600;
      width: 120px;
      min-width: 120px;
      max-width: 160px;
      text-align: center;
      flex-shrink: 0;
      margin-right: 10px;
    }
    .driver-card-header .driver-date[type="date"]::-webkit-calendar-picker-indicator {
      filter: invert(1);
      cursor: pointer;
    }
    .driver-card-header .driver-delete {
      color: var(--red);
      font-size: 1.14em;
      border: none;
      background: none;
      cursor: pointer;
      margin-left: auto;
      border-radius: 50%;
      padding: 0.07em 0.36em;
      transition: background 0.11s;
      flex-shrink: 0;
    }
    .driver-fields-row {
      display: flex;
      align-items: center;
      gap: 1.2em;
      margin: 13px 0 3px 0;
      padding: 0 15px;
      justify-content: stretch;
    }
    .driver-fields-row label {
      font-size: 1em;
      font-weight: 600;
      color: #bbdefb;
      margin-right: 0.14em;
      font-family: inherit;
      white-space: nowrap;
    }
    .input-km-wrap {
      display: inline-flex;
      align-items: center;
      border-radius: 7px;
      background: #212a40;
      box-shadow: 0 1px 4px #009de018;
      margin: 0 0.15em;
      padding-left: 0.15em;
      padding-right: 0.2em;
    }
    .input-km-wrap input[type="number"] {
      width: 4.5em;
      font-size: 1.07em;
      padding: 0.42em 0.12em 0.42em 0.55em;
      background: #212a40;
      border: 1px solid #384164;
      border-radius: 7px 0 0 7px;
      color: #fff;
      outline: none;
      text-align: center;
      font-family: inherit;
      font-weight: 700;
      white-space: nowrap;
      box-shadow: none;
    }
    .input-km-wrap .km-unit {
      font-size: 0.98em;
      color: #7ec5fd;
      margin-left: 0.2em;
      margin-right: 0.3em;
      font-weight: 700;
      white-space: nowrap;
      background: transparent;
      border: none;
      padding: 0;
      pointer-events: none;
      user-select: none;
    }
    .driver-km-result {
      margin: 0 0 2px 0;
      font-size: 1.08em;
      font-weight: 700;
      color: var(--primary);
      font-family: inherit;
      letter-spacing: 0.04em;
      text-align: left;
      padding: 0 15px;
      min-height: 21px;
      display: flex;
      align-items: center;
      gap: 0.4em;
    }
    .driver-timer-bar {
      display: flex;
      align-items: center;
      gap: 0.6em;
      margin: 0 0 2px 0;
      min-height: 1.4em;
      padding: 0 15px;
    }
    .driver-timer {
      font-size: 1.08em;
      font-weight: 800;
      color: #ffc107;
      background: #212a40;
      border-radius: 7px;
      padding: 2px 14px;
      min-width: 4.6em;
      text-align: center;
      letter-spacing: 0.025em;
      font-family: inherit;
      border: 1.1px solid #009de055;
      box-shadow: 0 1px 7px #009de022;
    }
    .driver-btns {
      display: flex;
      gap: 0.7em;
      margin-top: 8px;
      padding: 0 15px 15px 15px;
    }
    .driver-btns button {
      flex: 1 1 0;
      font-size: 1.03em;
      font-weight: 700;
      border: none;
      border-radius: 9px;
      padding: 0.65em 0;
      background: linear-gradient(90deg,var(--primary),var(--primary-hover));
      color: #fff;
      box-shadow: 0 1px 4px rgba(66,165,245,0.09);
      cursor: pointer;
      letter-spacing: 0.04em;
      transition: background 0.13s;
      min-width: 0;
      font-family: inherit;
    }
    .driver-btns button:active { background: var(--primary-hover);}
    .driver-btns .stop-btn {
      background: linear-gradient(90deg,#ff3b30 30%,#c11 100%);
      color: #fff;
      font-family: inherit;
    }
    .driver-btns .stop-btn:active { background: #ff3b30;}
    .driver-btns .disabled, .driver-btns button:disabled {
      opacity: 0.5;
      pointer-events: none;
    }
    .how-to-use {
      width: 100vw;
      max-width: 1050px;
      margin: 18px auto 0 auto;
      padding: 13px 14px 11px 14px;
      background: #161a23cc;
      border-radius: 10px;
      color: #bbdefb;
      font-size: 0.97em;
      font-family: 'Poppins', Arial, sans-serif;
      text-align: left;
      line-height: 1.6;
      letter-spacing: 0.01em;
      box-shadow: 0 2px 8px #212a4033;
      box-sizing: border-box;
      overflow-x: hidden;
      align-self: center;
    }
    .realtime-table {
      width: 98%;
      max-width: 1200px;
      margin: 24px auto 15px auto;
      border-collapse: collapse;
      background: #1b2438;
      border-radius: 14px;
      box-shadow: 0 2px 14px #0a2a5a22;
      overflow-x: auto;
    }
    .realtime-table th, .realtime-table td {
      padding: 9px 17px;
      border-bottom: 1px solid #314264;
      font-size: 1em;
      font-family: 'Poppins', Arial, sans-serif;
    }
    .realtime-table th {
      background: #17305c;
      color: #bbdefb;
      font-weight: 800;
      letter-spacing: 0.03em;
      border-top: none;
    }
    .realtime-table tr:last-child td {
      border-bottom: none;
    }
    .realtime-table td {
      color: #e3f3ff;
      font-weight: 600;
    }
    @media (max-width: 1100px) {
      .log-board {
        max-width: 99vw;
      }
      .driver-card {
        min-width: 0;
        max-width: 99vw;
      }
    }
    @media (max-width: 900px) {
      .log-board {
        grid-template-columns: 1fr;
        padding: 0 8px;
        gap: 16px;
      }
      .driver-card {
        min-width: 98vw;
        max-width: 98vw;
        font-size: 0.97em;
      }
      .realtime-table th, .realtime-table td { padding: 7px 3vw; font-size: 0.93em; }
      .realtime-table { font-size: 0.93em; }
    }
    @media (max-width: 600px) {
      .log-board { grid-template-columns: 1fr; padding: 0 2px; gap:16px;}
      .driver-card { min-width: 99vw; max-width: 99vw; font-size: 0.96em;}
      .realtime-table th, .realtime-table td { padding: 6px 2vw; font-size: 0.90em;}
      .driver-card-header .driver-date {
        width: 130px;
        min-width: 120px;
        max-width: 140px;
        font-size: 1.05em;
      }
    }
    @media (max-width: 450px) {
      .driver-card-header, .driver-fields-row, .driver-btns, .driver-km-result, .driver-timer-bar {padding-left:4px;padding-right:4px;}
      .driver-card { font-size: 0.93em;}
      .realtime-table th, .realtime-table td { padding: 5px 1vw; font-size: 0.85em;}
    }
    .modal-bg {
      display: none;
      position: fixed;
      z-index: 500;
      top: 0; left: 0; right: 0; bottom: 0;
      width: 100vw; height: 100vh;
      background: rgba(13, 32, 70, 0.82);
      align-items: center;
      justify-content: center;
    }
    .modal-bg.active {
      display: flex;
    }
    .modal-content {
      background: var(--card-bg);
      color: var(--accent);
      border-radius: 18px;
      border: 2px solid var(--primary);
      box-shadow: 0 7px 32px #42a5f547;
      padding: 28px 30px 22px 30px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 270px;
      max-width: 95vw;
      min-height: 135px;
      font-family: 'Poppins', Arial, sans-serif;
      animation: pop .18s cubic-bezier(.45,1.4,.68,1.02);
      position: relative;
    }
    .modal-title {
      font-size: 1.12em;
      font-weight: 700;
      color: #fff;
      margin-bottom: 9px;
      text-align: center;
      letter-spacing: 0.02em;
    }
    .modal-details {
      margin-bottom: 16px;
      color: var(--accent);
      font-size: 1em;
      font-weight: 500;
      text-align: center;
      word-break: break-word;
    }
    .modal-done-btn {
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 1.01em;
      font-weight: 700;
      padding: 10px 34px;
      cursor: pointer;
      transition: background 0.18s;
      margin-top: 2px;
      font-family: inherit;
      box-shadow: 0 2px 8px #42a5f533;
      letter-spacing: 0.03em;
    }
    .modal-done-btn:hover {
      background: var(--primary-hover);
    }
    .modal-close {
      position: absolute;
      top: 11px; right: 16px;
      background: none;
      border: none;
      color: #bbdefb;
      font-size: 1.22em;
      cursor: pointer;
      padding: 0;
      border-radius: 50%;
      transition: background 0.12s;
    }
    .modal-close:active {
      background: #212a40;
    }
    @keyframes pop {
      from { transform: scale(0.91); opacity: 0.3;}
      to   { transform: scale(1);    opacity: 1;}
    }
    .report-bar {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 0.8em;
      margin: 16px 0 10px 0;
      padding: 0 4vw;
      flex-wrap: wrap;
      max-width: 1200px;
      width: 98vw;
    }
    .report-bar button {
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 9px;
      font-size: 0.97rem;
      font-weight: 700;
      padding: 7px 18px;
      cursor: pointer;
      transition: background 0.16s;
      font-family: inherit;
      letter-spacing: 0.01em;
      display: flex;
      align-items: center;
      gap: 0.22em;
    }
    .report-bar button.active,
    .report-bar button:active {
      background: var(--primary-hover);
    }
    .report-bar select {
      font-size: 1em;
      border-radius: 7px;
      padding: 6px 12px;
      background: #212a40;
      color: #bbdefb;
      border: 1px solid #384164;
      font-family: inherit;
      font-weight: 600;
      outline: none;
    }
    #tableWrapper {
      display: none;
      width: 100vw;
      max-width: 1200px;
      margin: 0 auto 25px auto;
      justify-content: center;
      align-items: flex-start;
      flex-direction: column;
    }
    #tableWrapper.active { display: flex!important; }
    .modal-confirm {
      background: var(--card-bg);
      color: var(--accent);
      border-radius: 18px;
      border: 2px solid var(--red);
      box-shadow: 0 7px 32px #ff3b3047;
      padding: 22px 24px 18px 24px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 230px;
      max-width: 95vw;
      min-height: 80px;
      font-family: 'Poppins', Arial, sans-serif;
      position: relative;
      animation: pop .18s cubic-bezier(.45,1.4,.68,1.02);
    }
    .modal-confirm-title {
      font-size: 1.09em;
      font-weight: 700;
      color: #fff;
      margin-bottom: 9px;
      text-align: center;
      letter-spacing: 0.02em;
    }
    .modal-confirm-details {
      margin-bottom: 16px;
      color: var(--accent);
      font-size: 1em;
      font-weight: 500;
      text-align: center;
      word-break: break-word;
    }
    .modal-confirm-btns {
      display: flex;
      gap: 18px;
      margin-top: 5px;
    }
    .modal-confirm-btn {
      background: var(--red);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 1.01em;
      font-weight: 700;
      padding: 7px 22px;
      cursor: pointer;
      transition: background 0.18s;
      font-family: inherit;
      box-shadow: 0 2px 8px #ff3b3033;
      letter-spacing: 0.03em;
    }
    .modal-confirm-btn:hover {
      background: #c11;
    }
    .modal-cancel-btn {
      background: var(--border);
      color: #bbdefb;
      border: none;
      border-radius: 10px;
      font-size: 1.01em;
      font-weight: 700;
      padding: 7px 22px;
      cursor: pointer;
      transition: background 0.18s;
      font-family: inherit;
      box-shadow: 0 2px 8px #212a4033;
      letter-spacing: 0.03em;
    }
  </style>
</head>
<body>
  <div class="page-wrapper">
    <div class="header">
      <div class="header-row">
        <span class="header-title">
          <i class="fas fa-car"></i> Delivery Drivers Log
        </span>
        <span class="header-desc">
          Ravintola Tandoori Villa &nbsp;|&nbsp; Log car drivers' shift kilometers and time daily
        </span>
      </div>
    </div>
    <div class="driver-addbar">
      <input type="text" id="newDriverName" placeholder="Add driver name..."/>
      <button id="addDriverBtn"><i class="fas fa-plus"></i> Add</button>
    </div>
    <div class="log-board" id="driverBoard"></div>

    <div class="how-to-use" id="howToUse">
      <b>How to use:</b><br>
      1. Add each delivery driver's name at the top.<br>
      2. For each driver, enter today's date and the starting kilometers, then press <b>Start</b>.<br>
      3. At the end of the shift, enter the ending kilometers and press <b>Stop</b>.<br>
      4. The timer and total kilometers will be shown for the day.<br>
      5. Remove a driver using the <i class="fas fa-trash"></i> icon if needed.<br>
      <br>
      <button id="showReportBtn" style="background:var(--primary);color:#fff;font-weight:700;padding:7px 18px;border-radius:8px;border:none;cursor:pointer;margin-top:7px;">
        <i class="fas fa-table"></i> Show Reports Table
      </button>
    </div>

    <div id="tableWrapper">
      <div class="report-bar">
        <button id="dailyBtn" class="active">Daily</button>
        <button id="weeklyBtn">Weekly</button>
        <button id="monthlyBtn">Monthly</button>
        <label style="color:#bbdefb;">Driver:</label>
        <select id="driverFilter"></select>
        <button id="closeTableBtn"><i class="fas fa-times"></i> Close Table</button>
      </div>
      <div id="reportLogs"></div>
    </div>

    <div class="modal-bg" id="modalBg">
      <div class="modal-content" id="modalContent">
        <button class="modal-close" id="modalClose" title="Close">&times;</button>
        <div class="modal-title"><i class="fas fa-check-circle" style="color:var(--primary);"></i> Shift Log Saved</div>
        <div class="modal-details" id="modalDetails"></div>
        <button class="modal-done-btn" id="modalDone">Done</button>
      </div>
    </div>
    <!-- Confirmation Modal for Delete -->
    <div class="modal-bg" id="confirmModalBg">
      <div class="modal-confirm" id="confirmModalContent">
        <div class="modal-confirm-title"><i class="fas fa-exclamation-triangle" style="color:var(--red);"></i> Confirm Delete</div>
        <div class="modal-confirm-details" id="confirmModalDetails"></div>
        <div class="modal-confirm-btns">
          <button class="modal-confirm-btn" id="confirmDeleteBtn">Delete</button>
          <button class="modal-cancel-btn" id="cancelDeleteBtn">Cancel</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCirYQ_46JiSkMIwCNs1nSi89dvB1MUg_A",
      authDomain: "deliverylog12.firebaseapp.com",
      databaseURL: "https://deliverylog12-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "deliverylog12",
      storageBucket: "deliverylog12.firebasestorage.app",
      messagingSenderId: "19081371357",
      appId: "1:19081371357:web:b9b59e732a4d90d4d44534",
      measurementId: "G-FSZXXZQSL0"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
  </script>
  <script>
    function pad2(n){return String(n).padStart(2,'0');}
    function toDisplayDate(isoStr) {
      // Accepts YYYY-MM-DD, returns DD/MMM/YYYY
      if (!isoStr) return '';
      const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      const [y, m, d] = isoStr.split('-');
      const mIndex = parseInt(m,10)-1;
      return `${pad2(d)}/${months[mIndex]}/${y}`;
    }
    function formatTimeOnly(d) {
      if(!d) return "";
      if(typeof d === "string") d = new Date(d);
      return pad2(d.getHours())+":"+pad2(d.getMinutes())+":"+pad2(d.getSeconds());
    }
    function formatTime(sec) {
      const h = String(Math.floor(sec/3600)).padStart(2,0);
      const m = String(Math.floor((sec%3600)/60)).padStart(2,0);
      const s = String(sec%60).padStart(2,0);
      return `${h}:${m}:${s}`;
    }
    function toISODate(dateStr) {
      // Accepts DD/MM/YYYY, returns YYYY-MM-DD
      const [d,m,y] = dateStr.split('/');
      return `${y}-${pad2(m)}-${pad2(d)}`;
    }
    let driverState = {};
    let drivers = {};
    const newDriverName = document.getElementById('newDriverName');
    const addDriverBtn = document.getElementById('addDriverBtn');
    const driverBoard = document.getElementById('driverBoard');
    const modalBg = document.getElementById('modalBg');
    const modalClose = document.getElementById('modalClose');
    const modalDone = document.getElementById('modalDone');
    const modalDetails = document.getElementById('modalDetails');
    const confirmModalBg = document.getElementById('confirmModalBg');
    const confirmModalDetails = document.getElementById('confirmModalDetails');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
    let pendingDeleteDriverId = null;

    function showModal(details) {
      modalDetails.innerHTML = details;
      modalBg.classList.add('active');
      setTimeout(() => { modalDone.focus(); }, 100);
    }
    function hideModal() {
      modalBg.classList.remove('active');
    }
    modalClose.onclick = hideModal;
    modalDone.onclick = hideModal;
    modalBg.onclick = function(e) {
      if (e.target === modalBg) hideModal();
    };
    function showConfirmModal(driverId, driverName) {
      confirmModalDetails.innerHTML = `Are you sure you want to delete <b>${driverName}</b>? This cannot be undone.`;
      confirmModalBg.classList.add('active');
      pendingDeleteDriverId = driverId;
      setTimeout(() => { confirmDeleteBtn.focus(); }, 100);
    }
    function hideConfirmModal() {
      confirmModalBg.classList.remove('active');
      pendingDeleteDriverId = null;
    }
    cancelDeleteBtn.onclick = hideConfirmModal;
    confirmModalBg.onclick = function(e) {
      if (e.target === confirmModalBg) hideConfirmModal();
    };
    confirmDeleteBtn.onclick = function() {
      if (pendingDeleteDriverId) {
        db.ref("drivers/" + pendingDeleteDriverId).remove();
        hideConfirmModal();
      }
    };
    addDriverBtn.onclick = () => {
      const name = newDriverName.value.trim();
      if (!name) return;
      const exists = Object.values(drivers).some(d => d.name.toLowerCase() === name.toLowerCase());
      if (exists) return alert("Driver already exists.");
      const id = db.ref("drivers").push().key;
      db.ref("drivers/" + id).set({
        name,
        date: new Date().toISOString().slice(0,10)
      });
      newDriverName.value = '';
    };
    newDriverName.addEventListener("keypress", e => {
      if (e.key === "Enter") addDriverBtn.click();
    });
    db.ref("drivers").on("value", snap => {
      drivers = snap.val() || {};
      renderDrivers();
    });
    function renderDrivers() {
      driverBoard.innerHTML = "";
      const driverArr = Object.entries(drivers);
      if (!driverArr.length) {
        driverBoard.innerHTML = `<div style="color:#93c7e6; text-align:center;margin:1em 0;font-family:'Poppins',sans-serif;font-weight:600;">No drivers. Add some above.</div>`;
        return;
      }
      driverArr.forEach(([driverId, driverObj]) => {
        if (!driverState[driverId]) driverState[driverId] = {
          kmIn: "",
          kmOut: "",
          timer: 0,
          running: false,
          timerInterval: null,
          startTime: null,
          timeIn: null,
          timeOut: null,
          date: driverObj.date || (new Date()).toISOString().slice(0,10)
        };
        const s = driverState[driverId];
        const card = document.createElement('div');
        card.className = 'driver-card' + (s.running ? ' active' : '');
        const headerRow = document.createElement('div');
        headerRow.className = 'driver-card-header';
        const nameEl = document.createElement('span');
        nameEl.className = 'driver-name';
        nameEl.textContent = driverObj.name;
        const dateEl = document.createElement('input');
        dateEl.type = 'date';
        dateEl.className = 'driver-date';
        dateEl.value = s.date;
        dateEl.maxLength = 10;
        dateEl.onchange = e => {
          const val = e.target.value.trim();
          if (/^\d{4}-\d{2}-\d{2}$/.test(val)) {
            s.date = val;
            renderDrivers();
          } else {
            e.target.value = s.date;
          }
        };
        dateEl.onclick = function(e) { e.target.showPicker && e.target.showPicker(); };
        dateEl.onblur = dateEl.onkeyup = function(e) {
          if (!/^\d{4}-\d{2}-\d{2}$/.test(dateEl.value)) {
            dateEl.value = s.date;
          }
        };
        const delBtn = document.createElement('button');
        delBtn.className = 'driver-delete';
        delBtn.title = "Remove driver";
        delBtn.innerHTML = "<i class='fas fa-trash'></i>";
        delBtn.onclick = () => showConfirmModal(driverId, driverObj.name);
        headerRow.appendChild(nameEl);
        headerRow.appendChild(dateEl);
        headerRow.appendChild(delBtn);
        card.appendChild(headerRow);
        const fieldsRow = document.createElement('div');
        fieldsRow.className = 'driver-fields-row';
        const kmInLbl = document.createElement('label');
        kmInLbl.textContent = "In";
        const kmInWrap = document.createElement('span');
        kmInWrap.className = 'input-km-wrap';
        const kmIn = document.createElement('input');
        kmIn.type = 'number';
        kmIn.placeholder = 'Start';
        kmIn.value = s.kmIn;
        kmIn.disabled = s.running;
        kmIn.oninput = e => { s.kmIn = e.target.value; renderKmResult(); };
        const kmInUnit = document.createElement('span');
        kmInUnit.className = 'km-unit';
        kmInUnit.textContent = "Km";
        kmInWrap.appendChild(kmIn);
        kmInWrap.appendChild(kmInUnit);
        fieldsRow.appendChild(kmInLbl);
        fieldsRow.appendChild(kmInWrap);
        const kmOutLbl = document.createElement('label');
        kmOutLbl.textContent = "Out";
        const kmOutWrap = document.createElement('span');
        kmOutWrap.className = 'input-km-wrap';
        const kmOut = document.createElement('input');
        kmOut.type = 'number';
        kmOut.placeholder = 'End';
        kmOut.value = s.kmOut;
        kmOut.disabled = !s.running;
        kmOut.oninput = e => { s.kmOut = e.target.value; renderKmResult(); };
        const kmOutUnit = document.createElement('span');
        kmOutUnit.className = 'km-unit';
        kmOutUnit.textContent = "Km";
        kmOutWrap.appendChild(kmOut);
        kmOutWrap.appendChild(kmOutUnit);
        fieldsRow.appendChild(kmOutLbl);
        fieldsRow.appendChild(kmOutWrap);
        card.appendChild(fieldsRow);
        const kmResult = document.createElement('div');
        kmResult.className = 'driver-km-result';
        function renderKmResult() {
          if(s.kmIn && s.kmOut && !isNaN(+s.kmIn) && !isNaN(+s.kmOut) && +s.kmOut >= +s.kmIn) {
            kmResult.innerHTML = `<i class="fas fa-road"></i> Today: <span style="font-weight:900;color:var(--primary)">` + (+s.kmOut - +s.kmIn) + ` km</span>`;
          } else { kmResult.textContent = ''; }
        }
        renderKmResult();
        card.appendChild(kmResult);
        const timerBar = document.createElement('div');
        timerBar.className = 'driver-timer-bar';
        const timerDisplay = document.createElement('span');
        timerDisplay.className = 'driver-timer';
        timerDisplay.textContent = formatTime(s.timer);
        timerBar.appendChild(timerDisplay);
        card.appendChild(timerBar);
        const btns = document.createElement('div');
        btns.className = 'driver-btns';
        const startBtn = document.createElement('button');
        startBtn.innerHTML = `<i class="fas fa-play"></i> Start`;
        startBtn.disabled = s.running || !s.kmIn || !s.date;
        startBtn.onclick = () => {
          s.running = true;
          s.startTime = new Date();
          s.timeIn = new Date();
          s.timer = 0;
          startBtn.disabled = true;
          stopBtn.disabled = false;
          kmIn.disabled = true;
          kmOut.disabled = false;
          timerDisplay.textContent = formatTime(s.timer);
          s.timerInterval = setInterval(() => {
            s.timer = Math.floor((new Date() - s.startTime)/1000);
            timerDisplay.textContent = formatTime(s.timer);
          }, 1000);
          card.classList.add('active');
        };
        btns.appendChild(startBtn);
        const stopBtn = document.createElement('button');
        stopBtn.innerHTML = `<i class="fas fa-stop"></i> Stop`;
        stopBtn.className = "stop-btn";
        stopBtn.disabled = !s.running || !s.kmOut;
        stopBtn.onclick = () => {
          if (!s.kmOut || Number(s.kmOut) < Number(s.kmIn)) {
            alert("Enter valid ending km (greater than or equal to start)");
            return;
          }
          s.running = false;
          if (s.timerInterval) clearInterval(s.timerInterval);
          s.timerInterval = null;
          s.timeOut = new Date();
          startBtn.disabled = false;
          stopBtn.disabled = true;
          kmIn.disabled = false;
          kmOut.disabled = true;
          timerDisplay.textContent = formatTime(s.timer);
          renderKmResult();
          card.classList.remove('active');
          const log = {
            date: s.date,
            name: driverObj.name,
            timeIn: s.timeIn ? formatTimeOnly(s.timeIn) : "",
            timeOut: s.timeOut ? formatTimeOnly(s.timeOut) : "",
            kmIn: s.kmIn,
            kmOut: s.kmOut,
            totalKm: (+s.kmOut - +s.kmIn).toString(),
            totalTime: formatTime(s.timer)
          };
          db.ref("logs").push(log);
          showModal(
            `<b><i class="fas fa-user"></i> ${driverObj.name}</b><br>
            <span style="color:#fff;">${toDisplayDate(s.date)}</span><br>
            <span style="color:var(--primary)">Total: ${+s.kmOut - +s.kmIn} km</span><br>
            <span>Time: ${formatTime(s.timer)}</span>`
          );
          s.kmIn = ""; s.kmOut = ""; s.timer = 0; s.startTime = null; s.timeIn = null; s.timeOut = null;
          timerDisplay.textContent = formatTime(0);
          renderDrivers();
        };
        btns.appendChild(stopBtn);
        card.appendChild(btns);
        driverBoard.appendChild(card);
      });
    }
    setInterval(() => {
      Array.from(driverBoard.children).forEach((card, i) => {
        const driverId = Object.keys(drivers)[i];
        const s = driverState[driverId];
        if (!s) return;
        const btns = card.querySelectorAll('.driver-btns button');
        const kmIn = card.querySelector('.driver-fields-row .input-km-wrap input[type="number"]:nth-child(1)');
        const kmOut = card.querySelectorAll('.driver-fields-row .input-km-wrap input[type="number"]')[1];
        if (btns.length === 2) {
          btns[0].disabled = s.running || !s.kmIn || !s.date;
          btns[1].disabled = !s.running || !s.kmOut;
        }
        if (kmIn) kmIn.disabled = s.running;
        if (kmOut) kmOut.disabled = !s.running;
        const kmResult = card.querySelector('.driver-km-result');
        if(kmResult) {
          if(s.kmIn && s.kmOut && !isNaN(+s.kmIn) && !isNaN(+s.kmOut) && +s.kmOut >= +s.kmIn) {
            kmResult.innerHTML = `<i class="fas fa-road"></i> Today: <span style="font-weight:900;color:var(--primary)">` + (+s.kmOut - +s.kmIn) + ` km</span>`;
          } else { kmResult.textContent = ''; }
        }
        if (s.running) card.classList.add('active');
        else card.classList.remove('active');
      });
    }, 350);

    let allLogs = {};
    db.ref("logs").on("value", snap => {
      allLogs = snap.val()||{};
      updateReportTable();
      updateDriverFilterOptions();
    });
    const showReportBtn = document.getElementById('showReportBtn');
    const tableWrapper = document.getElementById('tableWrapper');
    const reportLogs = document.getElementById('reportLogs');
    const dailyBtn = document.getElementById('dailyBtn');
    const weeklyBtn = document.getElementById('weeklyBtn');
    const monthlyBtn = document.getElementById('monthlyBtn');
    const driverFilter = document.getElementById('driverFilter');
    const closeTableBtn = document.getElementById('closeTableBtn');
    let reportPeriod = "daily";
    let reportDriver = "All";
    function updateDriverFilterOptions() {
      const names = new Set();
      Object.values(allLogs).forEach(row => { if(row.name) names.add(row.name); });
      const opts = ['All', ...Array.from(names).sort()];
      driverFilter.innerHTML = opts.map(n => `<option value="${n}">${n}</option>`).join('');
      if (!opts.includes(reportDriver)) reportDriver = "All";
      driverFilter.value = reportDriver;
    }
    function filterLogs() {
      const arr = Object.values(allLogs||{});
      if (!arr.length) return [];
      let filtered = arr;
      if (reportDriver !== "All") filtered = filtered.filter(row => row.name === reportDriver);
      const now = new Date();
      if (reportPeriod === "daily") {
        const today = now.toISOString().slice(0,10);
        filtered = filtered.filter(row => row.date === today);
      } else if (reportPeriod === "weekly") {
        function getWeek(d) {
          d = new Date(d);
          d.setHours(0,0,0,0);
          d.setDate(d.getDate() + 4 - (d.getDay()||7));
          const yearStart = new Date(d.getFullYear(),0,1);
          return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
        }
        const thisYear = now.getFullYear();
        const thisWeek = getWeek(now);
        filtered = filtered.filter(row => {
          if (!row.date) return false;
          const d = new Date(row.date);
          return d.getFullYear() === thisYear && getWeek(d) === thisWeek;
        });
      } else if (reportPeriod === "monthly") {
        const thisMonth = now.toISOString().slice(0,7);
        filtered = filtered.filter(row => (row.date||"").slice(0,7) === thisMonth);
      }
      filtered.sort((a, b) => {
        if(a.date !== b.date) return b.date.localeCompare(a.date);
        return (a.name||"").localeCompare(b.name||"");
      });
      return filtered;
    }
    function updateReportTable() {
      if (!tableWrapper.classList.contains('active')) return;
      const arr = filterLogs();
      if (!arr.length) {
        reportLogs.innerHTML = "<div style='color:#bbb;text-align:center;margin:18px'>No logs found for this period.</div>";
        return;
      }
      let html = `<table class="realtime-table"><thead>
        <tr><th>Date</th><th>Name</th><th>Start Km</th><th>End Km</th><th>Total Km</th><th>Total Time</th></tr>
      </thead><tbody>`;
      for(const row of arr){
        html += `<tr>
          <td>${toDisplayDate(row.date||"")}</td>
          <td>${row.name||""}</td>
          <td>${row.kmIn||""}</td>
          <td>${row.kmOut||""}</td>
          <td>${row.totalKm||""}</td>
          <td>${row.totalTime||""}</td>
        </tr>`;
      }
      html += "</tbody></table>";
      reportLogs.innerHTML = html;
    }
    function setPeriod(period) {
      reportPeriod = period;
      dailyBtn.classList.toggle('active', period==='daily');
      weeklyBtn.classList.toggle('active', period==='weekly');
      monthlyBtn.classList.toggle('active', period==='monthly');
      updateReportTable();
    }
    dailyBtn.onclick = () => setPeriod('daily');
    weeklyBtn.onclick = () => setPeriod('weekly');
    monthlyBtn.onclick = () => setPeriod('monthly');
    driverFilter.onchange = e => {
      reportDriver = driverFilter.value;
      updateReportTable();
    };
    showReportBtn.onclick = () => {
      tableWrapper.classList.add('active');
      updateReportTable();
      updateDriverFilterOptions();
      window.scrollTo(0, tableWrapper.offsetTop-30);
    };
    closeTableBtn.onclick = () => {
      tableWrapper.classList.remove('active');
    };
  </script>
</body>
</html>
